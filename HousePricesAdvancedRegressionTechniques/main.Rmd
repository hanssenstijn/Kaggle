---
title: "House Prices"
author: "Stijn Hanssen"
date: "1 November 2018"
output: html_document
---

### Clear working space
First step is to make sure that the working space is empty.
```{r}
# clear all variables
rm(list=ls()) 
```

### Load packages
Loading the required packages for specific functions. If the packaged aren't present, they will be automatically be downloaded.
```{r}
if (!require("pacman")) suppressPackageStartupMessages(install.packages("pacman"))
pacman::p_load("stringr","GLDEX","RSEIS","DescTools","caret")
```

### Set working directory
Choose the path were the data-sets are stored
```{r}
DATA.DIR <- "~/GitHub/Kaggle/HousePricesAdvancedRegressionTechniques"
setwd(DATA.DIR)
# See which files are in WD
list.files() 
```

### Import data
```{r}
train <- read.csv("train.csv",stringsAsFactors = F,header = T)
test <- read.csv("test.csv", stringsAsFactors =  F,header = T)
```

### Explanatory
```{r}
str(train)
head(train)
str(test)
head(test)
```

## Combine dataset
```{r}
SalePrice = train$SalePrice
train$SalePrice = NULL
combi = rbind(train,test)
```

```{r}
sort(colSums(is.na(combi)),decreasing = T)
```

## Handeling Na's
```{r}
fill_missing <- function(combined){
combined[["PoolQC"]][is.na(combined[["PoolQC"]])] <- "None"
combined[["MiscFeature"]][is.na(combined[["MiscFeature"]])] <- "None"
combined[["Alley"]][is.na(combined[["Alley"]])] <- "None"
combined[["Fence"]][is.na(combined[["Fence"]])] <- "None"
combined[["FireplaceQu"]][is.na(combined[["FireplaceQu"]])] <- "None"
combined[["LotFrontage"]][is.na(combined[["LotFrontage"]])] <- Mode(combined$LotFrontage,na.rm=T)
combined[["GarageYrBlt"]][is.na(combined[["GarageYrBlt"]])] <- 0
combined[["GarageFinish"]][is.na(combined[["GarageFinish"]])] <- "None"
combined[["GarageQual"]][is.na(combined[["GarageQual"]])] <- "None"
combined[["GarageCond"]][is.na(combined[["GarageCond"]])] <- "None"
combined[["GarageType"]][is.na(combined[["GarageType"]])] <- "None"
combined[["GarageCars"]][is.na(combined[["GarageCars"]])] <- 0
combined[["GarageArea"]][is.na(combined[["GarageArea"]])] <- 0
combined[["BsmtCond"]][is.na(combined[["BsmtCond"]])] <- "None"
combined[["BsmtExposure"]][is.na(combined[["BsmtExposure"]])] <- "None"
combined[["BsmtQual"]][is.na(combined[["BsmtQual"]])] <- "None"
combined[["BsmtFinType2"]][is.na(combined[["BsmtFinType2"]])] <- "None"
combined[["BsmtFinType1"]][is.na(combined[["BsmtFinType1"]])] <- "None"
combined[["BsmtFullBath"]][is.na(combined[["BsmtFullBath"]])] <- 0
combined[["BsmtHalfBath"]][is.na(combined[["BsmtHalfBath"]])] <- 0
combined[["BsmtFinSF1"]][is.na(combined[["BsmtFinSF1"]])] <- 0
combined[["BsmtFinSF2"]][is.na(combined[["BsmtFinSF2"]])] <- 0
combined[["BsmtUnfSF"]][is.na(combined[["BsmtUnfSF"]])] <- 0
combined[["TotalBsmtSF"]][is.na(combined[["TotalBsmtSF"]])] <- 0
combined[["MasVnrType"]][is.na(combined[["MasVnrType"]])] <- "None"
combined[["MasVnrArea"]][is.na(combined[["MasVnrArea"]])] <- 0
combined[["MSZoning"]][is.na(combined[["MSZoning"]])] <- Mode(combined$MSZoning,na.rm = T)
combined[["Utilities"]][is.na(combined[["Utilities"]])] <- Mode(combined$Utilities,na.rm = T)
combined[["Functional"]][is.na(combined[["Functional"]])] <- Mode(combined$Functional,na.rm = T)
combined[["Exterior1st"]][is.na(combined[["Exterior1st"]])] <- "Other"
combined[["Exterior2nd"]][is.na(combined[["Exterior2nd"]])] <- "Other"
combined[["Electrical"]][is.na(combined[["Electrical"]])] <- Mode(combined$Electrical,na.rm = T)
combined[["KitchenQual"]][is.na(combined[["KitchenQual"]])] <- Mode(combined$KitchenQual,na.rm = T)
combined[["SaleType"]][is.na(combined[["SaleType"]])] <- "Oth"
  return(combined)
}
```

## Handeling type of variable
```{r}
clean <- function(combined){
combined[["MSSubClass"]] <- factor(combined[["MSSubClass"]])
combined[["MoSold"]] <- factor(combined[["MoSold"]])
combined[["GarageYrBlt"]] <- factor(combined[["GarageYrBlt"]])
  
combined[["ExterQual"]] <- as.numeric(factor(combined[["ExterQual"]], levels=c("None","Po","Fa", "TA", "Gd", "Ex")))
  combined[["ExterCond"]] <- as.numeric(factor(combined[["ExterCond"]], levels=c("None","Po","Fa", "TA", "Gd", "Ex")))
  combined[["BsmtQual"]] <- as.numeric(factor(combined[["BsmtQual"]], levels=c("None","Po", "Fa", "TA", "Gd", "Ex")))
  combined[["BsmtCond"]] <- as.numeric(factor(combined[["BsmtCond"]], levels=c("None","Po", "Fa", "TA", "Gd", "Ex")))
  combined[["BsmtExposure"]] <- as.numeric(factor(combined[["BsmtExposure"]], levels=c("None","No", "Mn", "Av", "Gd")))
  combined[["BsmtFinType1"]] <- as.numeric(factor(combined[["BsmtFinType1"]], levels=c("None","Unf","LwQ","Rec","BLQ","ALQ","GLQ")))
  combined[["BsmtFinType2"]] <- as.numeric(factor(combined[["BsmtFinType2"]], levels=c("None","Unf","LwQ","Rec","BLQ","ALQ","GLQ")))
  combined[["HeatingQC"]] <- as.numeric(factor(combined[["HeatingQC"]], levels=c("None","Po", "Fa", "TA", "Gd", "Ex")))
  combined[["KitchenQual"]] <- as.numeric(factor(combined[["KitchenQual"]], levels=c("None","Po", "Fa", "TA", "Gd", "Ex")))
  combined[["FireplaceQu"]] <- as.numeric(factor(combined[["FireplaceQu"]], levels=c("None","Po", "Fa", "TA", "Gd", "Ex")))
  combined[["GarageQual"]] <- as.numeric(factor(combined[["GarageQual"]], levels=c("None","Po", "Fa", "TA", "Gd", "Ex")))
  combined[["GarageCond"]] <- as.numeric(factor(combined[["GarageCond"]], levels=c("None","Po", "Fa", "TA", "Gd", "Ex")))
  combined[["PoolQC"]] <- as.numeric(factor(combined[["PoolQC"]], levels=c("None", "Fa", "TA", "Gd", "Ex")))
   return(combined)
}
```

## Feature Engineering
```{r}
featureEng <- function(combined){
  combined[["OverallGrade"]] <- combined[["OverallQual"]] * combined[["OverallCond"]]
  combined[["GarageGrade"]] <- combined[["GarageQual"]] * combined[["GarageCond"]]
  combined[["ExterGrade"]] <- combined[["ExterQual"]] * combined[["ExterCond"]]
  combined[["KitchenScore"]] <- combined[["KitchenAbvGr"]] * combined[["KitchenQual"]]
  combined[["FireplaceScore"]] <- combined[["Fireplaces"]] * combined[["FireplaceQu"]]
  combined[["GarageScore"]] <- combined[["GarageArea"]] * combined[["GarageQual"]]
  combined[["PoolScore"]] <- combined[["PoolArea"]] * combined[["PoolQC"]]

  combined[["TotalBath"]] <- combined[["BsmtFullBath"]] + (0.5 * combined[["BsmtHalfBath"]]) + combined[["FullBath"]] + (0.5 * combined[["HalfBath"]])
  combined[["TotalSF"]] <- combined[["TotalBsmtSF"]] + combined[["X1stFlrSF"]] + combined[["X2ndFlrSF"]]
  combined[["TotalPorchSF"]] <- combined[["OpenPorchSF"]] + combined[["EnclosedPorch"]] + combined[["X3SsnPorch"]] + combined[["ScreenPorch"]]
    return(combined) 
}
```

```{r}
combi <- fill_missing(combi)
combi <- clean(combi)
combi <- featureEng(combi)
dmy <- dummyVars(" ~ .", data = combi)
combi2 <- data.frame(predict(dmy, newdata = combi))
```

## Visualization
As our response variable, Sale Price, is continuous, we will be utilizing regression models. One assumption of linear regression models is that the error between the observed and expected values (i.e., the residuals) should be normally distributed. Violations of this assumption often stem from a skewed response variable. Sale Price has a right skew, so we log + 1 transform it to normalize its distribution.
```{r}
hist(SalePrice)
train$SalePrice = log(SalePrice+1)
hist(train$SalePrice)
```

## Correlations
```{r}
training <-combi2[1:1460,]
training$SalePrice = log(SalePrice + 1)
typeof(training)
correlations <- cor(training)
correlations <- as.data.frame(correlations)
names <- row.names(correlations)
priceCorrelation <- correlations$SalePrice
correlations <- cbind(names, priceCorrelation)
correlations <- correlations[order(-priceCorrelation),]
correlations[1:11, 1:2]
```

## Check for outliers in the highly correlated variables
```{r}
plot(training$OverallQual,training$SalePrice)
plot(training$TotalSF,training$SalePrice)
plot(training$GrLivArea,training$SalePrice)
plot(training$GarageCars,training$SalePrice)
plot(training$ExterQual,training$SalePrice)
plot(training$TotalBath,training$SalePrice)
plot(training$KitchenQual,training$SalePrice)
plot(training$GarageScore,training$SalePrice)
plot(training$GarageArea,training$SalePrice)
plot(training$BsmtQual,training$SalePrice)
```

## outlier removal
4 houses that have a living area of more than 4000 square feet. Two houses with largest living areas dont fit the general curve fof the plot.
```{r}
training[which(training$GrLivArea > 4000), c("GrLivArea", "SalePrice")]
training <- training[-c(524,1299),]

```


