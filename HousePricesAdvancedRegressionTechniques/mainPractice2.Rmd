---
title: "House Prices"
author: "Stijn Hanssen"
date: "15 November 2018"
output: html_document
---

### Clear working space
First step is to make sure that the working space is empty.
```{r}
# clear all variables
rm(list=ls()) 
```

### Load packages
Loading the required packages for specific functions. If the packaged aren't present, they will be automatically be downloaded.
```{r}
if (!require("pacman")) suppressPackageStartupMessages(install.packages("pacman"))
pacman::p_load("stringr","GLDEX","RSEIS","DescTools","caret","plyr","Metrics","knitr","ggplot2","plyr","dplyr","corrplot","caret","gridExtra","scales","Rmisc","ggrepel","randomForest","psych","xgboost","Ckmeans.1d.dp")
```

### Set working directory
Choose the path were the data-sets are stored.
```{r}
DATA.DIR <- "~/GitHub/Kaggle/HousePricesAdvancedRegressionTechniques"
setwd(DATA.DIR)
# See which files are in WD
list.files() 
```

### Import data
The training and test set will be imported. stringsAsFactors will be set to False in order to prevent that the character columns will be set to factor variables.
```{r}
train <- read.csv("train.csv",stringsAsFactors = F)
test <- read.csv("test.csv", stringsAsFactors =  F)
```

### Check and edit the datasets
The structure shows that the variables are integers or characters. Furthermore, the iD variables can be removed from both datasets. But for the prediction of the test set we will need the Id variable thus those will be saved. The test set does not contain Saleprices, thus we will create it and give it "Na" values. Now that the datasets have equal rows and columns they will be combined.
```{r}
str(train)

train$Id = NULL
testID = test$Id
test$Id = NULL

test$SalePrice = NA

df.combined = rbind(train,test)
dim(df.combined)
```

### Exploring and visualizing the data
The summary of the Saleprice column shows that the average price for selling a house is `180921`. The median is lower than the mean thus the data will be Right-Skewed (Positive skewed), this is shown in the histogram.
```{r}
summary(df.combined$SalePrice)
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=SalePrice)) +
    geom_histogram(fill="blue",binwidth=10000)
```

### Determine the correlation of the numeric variables towards Saleprice
First a new dataset will be created containing only the nummeric variables. Correlation will be calculated to determine which variables correlate with others. For sale price we see that `OverallQual` and `GrLivArea` are the highest correlated to SalePrice.
```{r}
# store the numeric variables
idx = which(sapply(df.combined, is.numeric))
numVar = names(idx)
cat('There are', length(numVar), 'numeric variables')
df.num = df.combined[,numVar]
# calculate the correlation
corNum = cor(df.num,use="pairwise.complete.obs")

# select and sort on SalePrice
corSorted <- as.matrix(sort(corNum[,'SalePrice'], decreasing = TRUE))
# select only corelations above 0.5
CorHigh <- names(which(apply(corSorted, 1, function(x) abs(x)>0.5)))
corNum <- corNum[CorHigh, CorHigh]

corrplot.mixed(corNum, tl.col="black", tl.pos = "lt")
```

### Investigate the variables OverQuall and GrLivArea
As expected the improvement in Quality score of the house results in a higher house price. The Above grade (ground) living area square feet shows that there are two houses with a very high `GrLivArea` but nonetheless very low `SalePrice` which might indicate that these two points are outliers.
```{r}
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(OverallQual),y=SalePrice)) +
    geom_boxplot()
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=GrLivArea,y=SalePrice)) +
    geom_point() +
    geom_smooth(method="lm")
which(df.combined$GrLivArea > 4500)
# 2550 is from the test set so it wont have a saleprice
df.combined[c(524,1299),c('SalePrice',"GrLivArea","OverallQual")]
```

### Handeling missing data
In total 35 have missing values, whereas one of them is the SalePrice which we had set to Na for the test set (meaning that we are gonne clean 34 variables). The variables with  the highest amount of missing values are for the `PoolQC`, `MiscFeature`,`Alley` and `Fence`.
```{r}
na.cols <- which(colSums(is.na(df.combined)) > 0)
sort(colSums(sapply(df.combined[na.cols], is.na)), decreasing = TRUE)
```

#### PoolQC
   Ex   Excellent
   Gd   Good
   TA   Average/Typical
   Fa   Fair
   NA   No Pool
Pool quallity seems to be ordinal. Were No pool is the lowest and Exellent pool can be set as the highest.
```{r}
table(df.combined$PoolQC)
df.combined$PoolQC[is.na(df.combined$PoolQC)] = "None"
# label encoding variable
qualities <- c('None' = 0, 'Po' = 1, 'Fa' = 2, 'TA' = 3, 'Gd' = 4, 'Ex' = 5)
df.combined$PoolQC = as.integer(revalue(df.combined$PoolQC,qualities))
table(df.combined$PoolQC)
sum(table(df.combined$PoolQC))
```
Do all the house that have a pool (determined by pool quality) also have a pool area. We see that 3 variables do have a pool area but not a pool quality, these will get their quality score based on the overall house quality.
```{r}
which(df.combined$PoolQC > 0 & df.combined$PoolArea == 0)
which(df.combined$PoolQC == 0 & df.combined$PoolArea > 0)
df.combined[c(2421,2504,2600),c("PoolArea","PoolQC","OverallQual")]
df.combined$PoolQC[2421] = 4
df.combined$PoolQC[2504] = 5
df.combined$PoolQC[2600] = 2
which(df.combined$PoolQC == 0 & df.combined$PoolArea > 0)
sum(table(df.combined$PoolQC))
```

#### Miscellaneous feature
   Elev Elevator
   Gar2 2nd Garage (if not described in garage section)
   Othr Other
   Shed Shed (over 100 SF)
   TenC Tennis Court
   NA   None
This feature is not ordinal. Thus we will transform it into a factos
```{r}
df.combined$MiscFeature[is.na(df.combined$MiscFeature)] = "None"
df.combined$MiscFeature = as.factor(df.combined$MiscFeature)
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=MiscFeature,y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
table(df.combined$MiscFeature)
```

#### Alley
   Grvl Gravel
   Pave Paved
   NA   No alley access
  
```{r}
df.combined$Alley[is.na(df.combined$Alley)] = "None"
df.combined$Alley = as.factor(df.combined$Alley)

ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=Alley,y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
```

#### Fence
   GdPrv    Good Privacy
   MnPrv    Minimum Privacy
   GdWo Good Wood
   MnWw Minimum Wood/Wire
   NA   No Fence
First tought would be that it is a ordinal variable. However, the ggplot shows that having no fence means still a very high sales price. Thus making this variable a factor.
```{r}
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(Fence),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$Fence[is.na(df.combined$Fence)] = "None"
df.combined$Fence = as.factor(df.combined$Fence)
sum(table(df.combined$Fence))
```

#### FireplacesQuality
   Ex   Excellent - Exceptional Masonry Fireplace
   Gd   Good - Masonry Fireplace in main level
   TA   Average - Prefabricated Fireplace in main living area or Masonry Fireplace in basement
   Fa   Fair - Prefabricated Fireplace in basement
   Po   Poor - Ben Franklin Stove
   NA   No Fireplace
The quality of the fireplaces seems to be ordinal. 
```{r}
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(FireplaceQu),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$FireplaceQu[is.na(df.combined$FireplaceQu)] = "None"
df.combined$FireplaceQu = as.integer(revalue(df.combined$FireplaceQu,qualities))
table(df.combined$FireplaceQu)
sum(table(df.combined$FireplaceQu))
```

#### Lot
Lot frontage : Linear feet of street connected to property. Give the median of each neighborhood to the missing values.
```{r}
ggplot(data=df.combined[!is.na(df.combined$LotFrontage),],aes(x=as.factor(Neighborhood),y=LotFrontage)) +
    geom_bar(stat='summary',, fun.y = "median") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
for (i in 1:nrow(df.combined)){
        if(is.na(df.combined$LotFrontage[i])){
               df.combined$LotFrontage[i] <- as.integer(median(df.combined$LotFrontage[df.combined$Neighborhood==df.combined$Neighborhood[i]], na.rm=TRUE)) 
        }
}

```
Lot shape
   Reg  Regular 
   IR1  Slightly irregular
   IR2  Moderately Irregular
   IR3  Irregular
An irregular lot shape seems to have much higher salesrpices than the regular shapes.
```{r}
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(LotShape),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$LotShape = as.integer(revalue(df.combined$LotShape,c('Reg' = 0, 'IR1' = 1, 'IR2' = 2, 'IR3' = 3)))
table(df.combined$LotShape)
```
LotConfig
   Inside   Inside lot
   Corner   Corner lot
   CulDSac  Cul-de-sac
   FR2  Frontage on 2 sides of property
   FR3  Frontage on 3 sides of property
This variable is a factor.
```{r}
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(LotConfig),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$LotConfig = as.factor(df.combined$LotConfig)
table(df.combined$LotConfig)
sum(table(df.combined$LotConfig))
```

#### Garage variables
Garage year built
The ones with missing values will be given the year that the house was built.
```{r}
df.combined$GarageYrBlt[is.na(df.combined$GarageYrBlt)] = df.combined$YearBuilt[is.na(df.combined$GarageYrBlt)]
```
Garage type
 2Types   More than one type of garage
   Attchd   Attached to home
   Basment  Basement Garage
   BuiltIn  Built-In (Garage part of house - typically has room above garage)
   CarPort  Car Port
   Detchd   Detached from home
   NA   No Garage
```{r}
length(which(is.na(df.combined$GarageType) & is.na(df.combined$GarageFinish) & is.na(df.combined$GarageCond) & is.na(df.combined$GarageQual)))
kable(df.combined[!is.na(df.combined$GarageType) & is.na(df.combined$GarageFinish), c('GarageCars', 'GarageArea', 'GarageType', 'GarageCond', 'GarageQual', 'GarageFinish')])
df.combined$GarageCond[2127] = names(sort(-table(df.combined$GarageCond)))[1]
df.combined$GarageQual[2127] = names(sort(-table(df.combined$GarageQual)))[1]
df.combined$GarageFinish[2127] = names(sort(-table(df.combined$GarageFinish)))[1]
kable(df.combined[2127, c('GarageYrBlt', 'GarageCars', 'GarageArea', 'GarageType', 'GarageCond', 'GarageQual', 'GarageFinish')])
df.combined$GarageCars[2577] <- 0
df.combined$GarageArea[2577] <- 0
df.combined$GarageType[2577] <- NA
df.combined$GarageType[is.na(df.combined$GarageType)] = "None"
df.combined$GarageType = as.factor(df.combined$GarageType)
table(df.combined$GarageType)
sum(table(df.combined$GarageType))
```

Garage Finish
   Fin  Finished
   RFn  Rough Finished  
   Unf  Unfinished
   NA   No Garage
```{r}
df.combined$GarageFinish[is.na(df.combined$GarageFinish)] = "None"
df.combined$GarageFinish = as.integer(revalue(df.combined$GarageFinish,c('None' = 0,'Unf' = 1,'RFn' = 2,'Fin' = 3)))
table(df.combined$GarageFinish)
```
GarageQuality
   Ex   Excellent
   Gd   Good
   TA   Typical/Average
   Fa   Fair
   Po   Poor
   NA   No Garage
```{r}
df.combined$GarageQual[is.na(df.combined$GarageQual)] <- 'None'
df.combined$GarageQual<-as.integer(revalue(df.combined$GarageQual, qualities))
table(df.combined$GarageQual)
```


GarageCondition
   Ex   Excellent
   Gd   Good
   TA   Typical/Average
   Fa   Fair
   Po   Poor
   NA   No Garage
```{r}
df.combined$GarageCond[is.na(df.combined$GarageCond)] = "None"
df.combined$GarageCond = as.integer((revalue(df.combined$GarageCond,qualities)))
table(df.combined$GarageCond)
```

#### Basement

```{r}
length(which(is.na(df.combined$BsmtQual) & is.na(df.combined$BsmtCond) & is.na(df.combined$BsmtExposure) & is.na(df.combined$BsmtFinType1) & is.na(df.combined$BsmtFinType2)))

df.combined[!is.na(df.combined$BsmtFinType1) & (is.na(df.combined$BsmtCond)|is.na(df.combined$BsmtQual)|is.na(df.combined$BsmtExposure)|is.na(df.combined$BsmtFinType2)), c('BsmtQual', 'BsmtCond', 'BsmtExposure', 'BsmtFinType1', 'BsmtFinType2')]

df.combined$BsmtFinType2[333] = names(sort(-table(df.combined$BsmtFinType2)))[1]
df.combined$BsmtExposure[c(949,1488,2349)] = names(sort(-table(df.combined$BsmtExposure)))[1]
df.combined$BsmtCond[c(2014,2186,2525)] = names(sort(-table(df.combined$BsmtCond)))[1]
df.combined$BsmtQual[c(2218,2219)] = names(sort(-table(df.combined$BsmtQual)))[1]
```
BsmtQual
   Ex   Excellent (100+ inches) 
   Gd   Good (90-99 inches)
   TA   Typical (80-89 inches)
   Fa   Fair (70-79 inches)
   Po   Poor (&lt;70 inches
   NA   No Basement
```{r}
df.combined$BsmtQual[is.na(df.combined$BsmtQual)] = "None"
df.combined$BsmtQual = as.integer(revalue(df.combined$BsmtQual,qualities))
table(df.combined$BsmtQual)
```
BsmtCond
   Ex   Excellent
   Gd   Good
   TA   Typical - slight dampness allowed
   Fa   Fair - dampness or some cracking or settling
   Po   Poor - Severe cracking, settling, or wetness
   NA   No Basement
```{r}
df.combined$BsmtCond[is.na(df.combined$BsmtCond)] = "None"
df.combined$BsmtCond = as.integer(revalue(df.combined$BsmtCond,qualities))
table(df.combined$BsmtCond)
```
BsmtExposure
   Gd   Good Exposure
   Av   Average Exposure (split levels or foyers typically score average or above)  
   Mn   Mimimum Exposure
   No   No Exposure
   NA   No Basement
```{r}
df.combined$BsmtExposure[is.na(df.combined$BsmtExposure)] = "None"
df.combined$BsmtExposure = as.integer(revalue(df.combined$BsmtExposure,c('None'=0,'No'=1,'Mn'=2,'Av'=3,'Gd'=4)))
table(df.combined$BsmtExposure)
sum(table(df.combined$BsmtExposure))
```
BsmtFinType1
   GLQ  Good Living Quarters
   ALQ  Average Living Quarters
   BLQ  Below Average Living Quarters   
   Rec  Average Rec Room
   LwQ  Low Quality
   Unf  Unfinshed
   NA   No Basement
```{r}
df.combined$BsmtFinType1[is.na(df.combined$BsmtFinType1)] = "None"
df.combined$BsmtFinType1 = as.integer(revalue(df.combined$BsmtFinType1,c('None'=0, 'Unf'=1, 'LwQ'=2, 'Rec'=3, 'BLQ'=4, 'ALQ'=5, 'GLQ'=6)))
table(df.combined$BsmtFinType1)
sum(table(df.combined$BsmtFinType1))
```

```{r}
df.combined$BsmtFinType2[is.na(df.combined$BsmtFinType2)] <- 'None'
FinType <- c('None'=0, 'Unf'=1, 'LwQ'=2, 'Rec'=3, 'BLQ'=4, 'ALQ'=5, 'GLQ'=6)

df.combined$BsmtFinType2<-as.integer(revalue(df.combined$BsmtFinType2, FinType))
table(df.combined$BsmtFinType2)
```


Still some missing values. All of these will be set to zero for the reason that these ones just dont have a garage.
```{r}
df.combined[(is.na(df.combined$BsmtFullBath)|is.na(df.combined$BsmtHalfBath)|is.na(df.combined$BsmtFinSF1)|is.na(df.combined$BsmtFinSF2)|is.na(df.combined$BsmtUnfSF)|is.na(df.combined$TotalBsmtSF)), c('BsmtQual', 'BsmtFullBath', 'BsmtHalfBath', 'BsmtFinSF1', 'BsmtFinSF2', 'BsmtUnfSF', 'TotalBsmtSF')]

df.combined$BsmtFullBath[is.na(df.combined$BsmtFullBath)] <-0
df.combined$BsmtHalfBath[is.na(df.combined$BsmtHalfBath)] <-0
df.combined$BsmtFinSF1[is.na(df.combined$BsmtFinSF1)] <-0
df.combined$BsmtFinSF2[is.na(df.combined$BsmtFinSF2)] <-0
df.combined$BsmtUnfSF[is.na(df.combined$BsmtUnfSF)] <-0
df.combined$TotalBsmtSF[is.na(df.combined$TotalBsmtSF)] <-0
```

#### Masonry

```{r}
length(which(is.na(df.combined$MasVnrArea) & is.na(df.combined$MasVnrType)))
df.combined[!is.na(df.combined$MasVnrArea) & is.na(df.combined$MasVnrType),c('MasVnrArea','MasVnrType')]
df.combined$MasVnrType[2611] = names(sort(-table(df.combined$MasVnrType)))[2]
df.combined[2611,c('MasVnrType','MasVnrArea')]
```

   BrkCmn   Brick Common
   BrkFace  Brick Face
   CBlock   Cinder Block
   None None
   Stone    Stone
   
```{r}
df.combined$MasVnrType[is.na(df.combined$MasVnrType)] = "None"
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(MasVnrType),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))

df.combined$MasVnrType<-as.integer(revalue(df.combined$MasVnrType, c('None'=0, 'BrkCmn'=0, 'BrkFace'=1, 'Stone'=2)))
table(df.combined$MasVnrType)
```
MasVnrArea: Masonry veneer area in square feet
```{r}
df.combined$MasVnrArea[is.na(df.combined$MasVnrArea)] = 0
```

#### MSzonning
   A    Agriculture
   C    Commercial
   FV   Floating Village Residential
   I    Industrial
   RH   Residential High Density
   RL   Residential Low Density
   RP   Residential Low Density Park 
   RM   Residential Medium Density
MSZoning: Identifies the general zoning classification of the sale.
```{r}
which(is.na(df.combined$MSZoning))
df.combined$MSZoning[is.na(df.combined$MSZoning)] = names(sort(-table(df.combined$MSZoning)))[1]
df.combined$MSZoning = as.factor(df.combined$MSZoning)
table(df.combined$MSZoning)
sum(table(df.combined$MSZoning))
```

#### Kitchen

KitchenQual
   Ex   Excellent
   Gd   Good
   TA   Typical/Average
   Fa   Fair
   Po   Poor
```{r}
df.combined$KitchenQual[is.na(df.combined$KitchenQual)] = names(sort(-table(df.combined$KitchenQual)))[1]
df.combined$KitchenQual = df.combined$KitchenQual = as.integer(revalue(df.combined$KitchenQual,qualities))
table(df.combined$KitchenQual)
sum(table(df.combined$KitchenQual))
```

Utilities
   AllPub   All public Utilities (E,G,W,& S)    
   NoSewr   Electricity, Gas, and Water (Septic Tank)
   NoSeWa   Electricity and Gas Only
   ELO  Electricity only  
```{r}
which(is.na(df.combined$Utilities))
table(df.combined$Utilities)
df.combined$Utilities = NULL
```

Home functionality
   Typ  Typical Functionality
   Min1 Minor Deductions 1
   Min2 Minor Deductions 2
   Mod  Moderate Deductions
   Maj1 Major Deductions 1
   Maj2 Major Deductions 2
   Sev  Severely Damaged
   Sal  Salvage only
```{r}
df.combined$Functional[is.na(df.combined$Functional)] = names(sort(-table(df.combined$Functional)))[1]
df.combined$Functional = df.combined$Functional = as.integer(revalue(df.combined$Functional,c('Sal'=0, 'Sev'=1, 'Maj2'=2, 'Maj1'=3, 'Mod'=4, 'Min2'=5, 'Min1'=6, 'Typ'=7)))
table(df.combined$Functional)
sum(table(df.combined$Functional))
```

Exterior
sbShng  Asbestos Shingles
   AsphShn  Asphalt Shingles
   BrkComm  Brick Common
   BrkFace  Brick Face
   CBlock   Cinder Block
   CemntBd  Cement Board
   HdBoard  Hard Board
   ImStucc  Imitation Stucco
   MetalSd  Metal Siding
   Other    Other
   Plywood  Plywood
   PreCast  PreCast 
   Stone    Stone
   Stucco   Stucco
   VinylSd  Vinyl Siding
   Wd Sdng  Wood Siding
   WdShing  Wood Shingles
```{r}
df.combined$Exterior1st[is.na(df.combined$Exterior1st)] = names(sort(-table(df.combined$Exterior1st)))[1]
df.combined$Exterior1st = as.factor(df.combined$Exterior1st)
sum(table(df.combined$Exterior1st))

df.combined$Exterior2nd[is.na(df.combined$Exterior2nd)] = names(sort(-table(df.combined$Exterior2nd)))[1]
df.combined$Exterior2nd = as.factor(df.combined$Exterior2nd)
sum(table(df.combined$Exterior2nd))
```

ExterQual
   Ex   Excellent
   Gd   Good
   TA   Average/Typical
   Fa   Fair
   Po   Poor
```{r}
df.combined$ExterQual = as.integer(revalue(df.combined$ExterQual,qualities))
table(df.combined$ExterQual)
sum(table(df.combined$ExterQual))
```

ExterCond
   Ex   Excellent
   Gd   Good
   TA   Average/Typical
   Fa   Fair
   Po   Poor
```{r}
df.combined$ExterCond = as.integer(revalue(df.combined$ExterCond,qualities))
table(df.combined$ExterCond)
sum(table(df.combined$ExterCond))
```

#### Electrical
   SBrkr    Standard Circuit Breakers & Romex
   FuseA    Fuse Box over 60 AMP and all Romex wiring (Average) 
   FuseF    60 AMP Fuse Box and mostly Romex wiring (Fair)
   FuseP    60 AMP Fuse Box and mostly knob & tube wiring (poor)
   Mix  Mixed
```{r}
df.combined$Electrical[is.na(df.combined$Electrical)] = names(sort(-table(df.combined$Electrical)))[1]
df.combined$Electrical = as.factor(df.combined$Electrical)
table(df.combined$Electrical)
sum(table(df.combined$Electrical))
```

#### Saletype and condition
   WD   Warranty Deed - Conventional
   CWD  Warranty Deed - Cash
   VWD  Warranty Deed - VA Loan
   New  Home just constructed and sold
   COD  Court Officer Deed/Estate
   Con  Contract 15% Down payment regular terms
   ConLw    Contract Low Down payment and low interest
   ConLI    Contract Low Interest
   ConLD    Contract Low Down
   Oth  Other
```{r}
df.combined$SaleType[is.na(df.combined$SaleType)] = names(sort(-table(df.combined$SaleType)))[1]
df.combined$SaleType = as.factor(df.combined$SaleType)
```
sale condition
   Normal   Normal Sale
   Abnorml  Abnormal Sale -  trade, foreclosure, short sale
   AdjLand  Adjoining Land Purchase
   Alloca   Allocation - two linked properties with separate deeds, typically condo with a garage unit  
   Family   Sale between family members
   Partial  Home was not completed when last assessed (associated with New Homes) number of bedrooms
```{r}
df.combined$SaleCondition = as.factor(df.combined$SaleCondition)
table(df.combined$SaleCondition)
sum(table(df.combined$SaleCondition))
```

#### Label encoding and factorizing the remaining character variables
Check which variables are still charater. Per variable will be decided if it has to be a categorical or ordinal variable/
```{r}
x = names(df.combined[,sapply(df.combined,is.character)])
x
```

Street
   Grvl Gravel  
   Pave Paved
```{r}
table(df.combined$Street)
df.combined$Street = df.combined$Street = as.integer(revalue(df.combined$Street,c('Grvl'=0, 'Pave'=1)))
table(df.combined$Street)
sum(table(df.combined$Street))
```

LandContour = Flatness of the property
   Lvl  Near Flat/Level 
   Bnk  Banked - Quick and significant rise from street grade to building
   HLS  Hillside - Significant slope from side to side
   Low  Depression
```{r}
table(df.combined$LandContour)
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(LandContour),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$LandContour = as.factor(df.combined$LandContour)
sum(table(df.combined$LandContour))
```
LandSlope = slope of property
   Gtl  Gentle slope
   Mod  Moderate Slope  
   Sev  Severe Slope
```{r}
table(df.combined$LandSlope)
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(LandSlope),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$LandSlope = as.factor(df.combined$LandSlope)
sum(table(df.combined$LandSlope))
```

Neighborhood =  Physical locations within Ames city limits
Blmngtn  Bloomington Heights
   Blueste  Bluestem
   BrDale   Briardale
   BrkSide  Brookside
   ClearCr  Clear Creek
   CollgCr  College Creek
   Crawfor  Crawford
   Edwards  Edwards
   Gilbert  Gilbert
   IDOTRR   Iowa DOT and Rail Road
   MeadowV  Meadow Village
   Mitchel  Mitchell
   Names    North Ames
   NoRidge  Northridge
   NPkVill  Northpark Villa
   NridgHt  Northridge Heights
   NWAmes   Northwest Ames
   OldTown  Old Town
   SWISU    South & West of Iowa State University
   Sawyer   Sawyer
   SawyerW  Sawyer West
   Somerst  Somerset
   StoneBr  Stone Brook
   Timber   Timberland
   Veenker  Veenker
```{r}
table(df.combined$Neighborhood)
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(Neighborhood),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$Neighborhood = as.factor(df.combined$Neighborhood)
sum(table(df.combined$Neighborhood))
```

Condition1 =  Proximity to various conditions
   Artery   Adjacent to arterial street
   Feedr    Adjacent to feeder street   
   Norm Normal  
   RRNn Within 200' of North-South Railroad
   RRAn Adjacent to North-South Railroad
   PosN Near positive off-site feature--park, greenbelt, etc.
   PosA Adjacent to postive off-site feature
   RRNe Within 200' of East-West Railroad
   RRAe Adjacent to East-West Railroad
```{r}
table(df.combined$Condition1)
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(Condition1),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$Condition1 = as.factor(df.combined$Condition1)
sum(table(df.combined$Condition1))
```

Condition2: Proximity to various conditions (if more than one is present)
   Artery   Adjacent to arterial street
   Feedr    Adjacent to feeder street   
   Norm Normal  
   RRNn Within 200' of North-South Railroad
   RRAn Adjacent to North-South Railroad
   PosN Near positive off-site feature--park, greenbelt, etc.
   PosA Adjacent to postive off-site feature
   RRNe Within 200' of East-West Railroad
   RRAe Adjacent to East-West Railroad
```{r}
table(df.combined$Condition2)
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(Condition2),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$Condition2 = as.factor(df.combined$Condition2)
sum(table(df.combined$Condition2))
```
BldgType: Type of dwelling
   1Fam Single-family Detached  
   2FmCon   Two-family Conversion; originally built as one-family dwelling
   Duplx    Duplex
   TwnhsE   Townhouse End Unit
   TwnhsI   Townhouse Inside Unit
```{r}
table(df.combined$BldgType)
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(BldgType),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$BldgType = as.factor(df.combined$BldgType)
sum(table(df.combined$BldgType))
```

HouseStyle: Style of dwelling
   1Story   One story
   1.5Fin   One and one-half story: 2nd level finished
   1.5Unf   One and one-half story: 2nd level unfinished
   2Story   Two story
   2.5Fin   Two and one-half story: 2nd level finished
   2.5Unf   Two and one-half story: 2nd level unfinished
   SFoyer   Split Foyer
   SLvl Split Level
```{r}
table(df.combined$HouseStyle)
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(HouseStyle),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$HouseStyle = as.factor(df.combined$HouseStyle)
sum(table(df.combined$HouseStyle))
```
RoofStyle: Type of roof
   Flat Flat
   Gable    Gable
   Gambrel  Gabrel (Barn)
   Hip  Hip
   Mansard  Mansard
   Shed Shed
```{r}
table(df.combined$RoofStyle)
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(RoofStyle),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$RoofStyle = as.factor(df.combined$RoofStyle)
sum(table(df.combined$RoofStyle))
```

RoofMatl: Roof material
   ClyTile  Clay or Tile
   CompShg  Standard (Composite) Shingle
   Membran  Membrane
   Metal    Metal
   Roll Roll
   Tar&Grv  Gravel & Tar
   WdShake  Wood Shakes
   WdShngl  Wood Shingles
```{r}
table(df.combined$RoofMatl)
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(RoofMatl),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$RoofMatl = as.factor(df.combined$RoofMatl)
sum(table(df.combined$RoofMatl))
```
Foundation: Type of foundation
   BrkTil   Brick & Tile
   CBlock   Cinder Block
   PConc    Poured Contrete 
   Slab Slab
   Stone    Stone
   Wood Wood
```{r}
table(df.combined$Foundation)
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(Foundation),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$Foundation = as.factor(df.combined$Foundation)
sum(table(df.combined$Foundation))
```

Heating: Type of heating
   Floor    Floor Furnace
   GasA Gas forced warm air furnace
   GasW Gas hot water or steam heat
   Grav Gravity furnace 
   OthW Hot water or steam heat other than gas
   Wall Wall furnace
```{r}
table(df.combined$Heating)
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(Heating),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$Heating = as.factor(df.combined$Heating)
sum(table(df.combined$Heating))
```

HeatingQC: Heating quality and condition
   Ex   Excellent
   Gd   Good
   TA   Average/Typical
   Fa   Fair
   Po   Poor
This variable seems to have an order. Thus we will make an ordinal variable from it.  
```{r}
table(df.combined$HeatingQC)
df.combined$HeatingQC = as.integer(revalue(df.combined$HeatingQC,qualities))
table(df.combined$HeatingQC)
sum(table(df.combined$HeatingQC))
```

CentralAir: Central air conditioning
   N    No
   Y    Yes
```{r}
table(df.combined$CentralAir)
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(CentralAir),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$CentralAir = as.integer(revalue(df.combined$CentralAir,c('N'=0,'Y'=1)))
table(df.combined$CentralAir)
sum(table(df.combined$CentralAir))
```

PavedDrive: Paved driveway
   Y    Paved 
   P    Partial Pavement
   N    Dirt/Gravel
```{r}
table(df.combined$PavedDrive)
ggplot(data=df.combined[!is.na(df.combined$SalePrice),],aes(x=as.factor(PavedDrive),y=SalePrice)) +
    geom_bar(stat='summary',, fun.y = "median") +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..))
df.combined$PavedDrive = as.integer(revalue(df.combined$PavedDrive,c('N'=0,'P'=1,'Y'=2)))
table(df.combined$PavedDrive)
sum(table(df.combined$PavedDrive))
```

Check which variables are still charater. Per variable will be decided if it has to be a categorical or ordinal variable/
```{r}
y = names(df.combined[,sapply(df.combined,is.character)])
y
```

### Changing numeric variabels into factors

The months sold variable is set as ordinal. However January is ofcourse not better than May. Therefor will this variable be set as categorical
```{r}
str(df.combined$MoSold)
df.combined$MoSold = as.factor(df.combined$MoSold)
```

MSsubclass

MSSubClass: Identifies the type of dwelling involved in the sale.	

        20	1-STORY 1946 & NEWER ALL STYLES
        30	1-STORY 1945 & OLDER
        40	1-STORY W/FINISHED ATTIC ALL AGES
        45	1-1/2 STORY - UNFINISHED ALL AGES
        50	1-1/2 STORY FINISHED ALL AGES
        60	2-STORY 1946 & NEWER
        70	2-STORY 1945 & OLDER
        75	2-1/2 STORY ALL AGES
        80	SPLIT OR MULTI-LEVEL
        85	SPLIT FOYER
        90	DUPLEX - ALL STYLES AND AGES
       120	1-STORY PUD (Planned Unit Development) - 1946 & NEWER
       150	1-1/2 STORY PUD - ALL AGES
       160	2-STORY PUD - 1946 & NEWER
       180	PUD - MULTILEVEL - INCL SPLIT LEV/FOYER
       190	2 FAMILY CONVERSION - ALL STYLES AND AGES

```{r}
df.combined$MSSubClass = as.factor(df.combined$MSSubClass)

df.combined$MSSubClass<-revalue(df.combined$MSSubClass, c('20'='1 story 1946+', '30'='1 story 1945-', '40'='1 story unf attic', '45'='1,5 story unf', '50'='1,5 story fin', '60'='2 story 1946+', '70'='2 story 1945-', '75'='2,5 story all ages', '80'='split/multi level', '85'='split foyer', '90'='duplex all style/age', '120'='1 story PUD 1946+', '150'='1,5 story PUD all', '160'='2 story PUD 1946+', '180'='PUD multilevel', '190'='2 family conversion'))

str(df.combined$MSSubClass)
```

### Correcting a typo
```{r}
df.combined$GarageYrBlt[2593] <- 2007 
```

### Save numeric and factor variables
```{r}
numericVar = which(sapply(df.combined,is.numeric))
catVar = which(sapply(df.combined,is.factor))
cat('There are', length(numericVar), 'numeric variables, and', length(catVar), 'categoric variables')
```

### Check correlation agin

```{r}
all_numVar <- df.combined[, numericVar]
cor_numVar <- cor(all_numVar, use="pairwise.complete.obs") #correlations of all numeric variables

#sort on decreasing correlations with SalePrice
cor_sorted <- as.matrix(sort(cor_numVar[,'SalePrice'], decreasing = TRUE))
 #select only high corelations
CorHigh <- names(which(apply(cor_sorted, 1, function(x) abs(x)>0.5)))
cor_numVar <- cor_numVar[CorHigh, CorHigh]

corrplot.mixed(cor_numVar, tl.col="black", tl.pos = "lt", tl.cex = 0.7,cl.cex = .7, number.cex=.7)
```

### Distribution Above Ground Living Area

```{r}
s1 <- ggplot(data= df.combined, aes(x=GrLivArea)) +
        geom_density() + labs(x='Square feet living area')
s2 <- ggplot(data=df.combined, aes(x=as.factor(TotRmsAbvGrd))) +
        geom_histogram(stat='count') + labs(x='Rooms above Ground')
s3 <- ggplot(data= df.combined, aes(x=X1stFlrSF)) +
        geom_density() + labs(x='Square feet first floor')
s4 <- ggplot(data= df.combined, aes(x=X2ndFlrSF)) +
        geom_density() + labs(x='Square feet second floor')
s5 <- ggplot(data= df.combined, aes(x=TotalBsmtSF)) +
        geom_density() + labs(x='Square feet basement')
s6 <- ggplot(data= df.combined[df.combined$LotArea<100000,], aes(x=LotArea)) +
        geom_density() + labs(x='Square feet lot')
s7 <- ggplot(data= df.combined, aes(x=LotFrontage)) +
        geom_density() + labs(x='Linear feet lot frontage')
s8 <- ggplot(data= df.combined, aes(x=LowQualFinSF)) +
        geom_histogram() + labs(x='Low quality square feet 1st & 2nd')

layout <- matrix(c(1,2,5,3,4,8,6,7),4,2,byrow=TRUE)
multiplot(s1, s2, s3, s4, s5, s6, s7, s8, layout=layout)
```

###The most important categorical variable; Neighborhood

The first graph shows the median SalePrice by Neighorhood (frequency of training set). The second graph below shows the frequencies across all data.

```{r, warning=FALSE, message=FALSE, out.width="100%"}
n1 <- ggplot(df.combined[!is.na(df.combined$SalePrice),], aes(x=Neighborhood, y=SalePrice)) +
        geom_bar(stat='summary', fun.y = "median", fill='blue') +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        scale_y_continuous(breaks= seq(0, 800000, by=50000), labels = comma) +
        geom_label(stat = "count", aes(label = ..count.., y = ..count..), size=3) +
        geom_hline(yintercept=163000, linetype="dashed", color = "red") #dashed line is median SalePrice
n2 <- ggplot(data=df.combined, aes(x=Neighborhood)) +
        geom_histogram(stat='count')+
        geom_label(stat = "count", aes(label = ..count.., y = ..count..), size=3)+
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
grid.arrange(n1, n2)
```

### Overall Quality frequency distribution, and other Quality variables
```{r, warning=FALSE, message=FALSE, out.width="100%"}
q1 <- ggplot(data=df.combined, aes(x=as.factor(OverallQual))) +
        geom_histogram(stat='count')
q2 <- ggplot(data=df.combined, aes(x=as.factor(ExterQual))) +
        geom_histogram(stat='count')
q3 <- ggplot(data=df.combined, aes(x=as.factor(BsmtQual))) +
        geom_histogram(stat='count')
q4 <- ggplot(data=df.combined, aes(x=as.factor(KitchenQual))) +
        geom_histogram(stat='count')
q5 <- ggplot(data=df.combined, aes(x=as.factor(GarageQual))) +
        geom_histogram(stat='count')
q6 <- ggplot(data=df.combined, aes(x=as.factor(FireplaceQu))) +
        geom_histogram(stat='count')
q7 <- ggplot(data=df.combined, aes(x=as.factor(PoolQC))) +
        geom_histogram(stat='count')

layout <- matrix(c(1,2,8,3,4,8,5,6,7),3,3,byrow=TRUE)
multiplot(q1, q2, q3, q4, q5, q6, q7, layout=layout)

```

###The second most important categorical variable; MSSubClass

The first visualization shows the median SalePrice by MSSubClass (frequency of training set). Most houses are relatively new, and have one or two stories.

```{r, warning=FALSE, out.width="100%"}
ms1 <- ggplot(df.combined[!is.na(df.combined$SalePrice),], aes(x=MSSubClass, y=SalePrice)) +
        geom_bar(stat='summary', fun.y = "median", fill='blue') +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        scale_y_continuous(breaks= seq(0, 800000, by=50000), labels = comma) +
        geom_label(stat = "count", aes(label = ..count.., y = ..count..), size=3) +
        geom_hline(yintercept=163000, linetype="dashed", color = "red") #dashed line is median SalePrice
ms2 <- ggplot(data=df.combined, aes(x=MSSubClass)) +
        geom_histogram(stat='count')+
        geom_label(stat = "count", aes(label = ..count.., y = ..count..), size=3) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
grid.arrange(ms1, ms2)
```

###Garage variables
```{r, warning=FALSE, message=FALSE, out.width="100%"}
g1 <- ggplot(data=df.combined[df.combined$GarageCars !=0,], aes(x=GarageYrBlt)) +
        geom_histogram()
g2 <- ggplot(data=df.combined, aes(x=as.factor(GarageCars))) +
        geom_histogram(stat='count')
g3 <- ggplot(data= df.combined, aes(x=GarageArea)) +
        geom_density()
g4 <- ggplot(data=df.combined, aes(x=as.factor(GarageCond))) +
        geom_histogram(stat='count')
g5 <- ggplot(data=df.combined, aes(x=GarageType)) +
        geom_histogram(stat='count')
g6 <- ggplot(data=df.combined, aes(x=as.factor(GarageQual))) +
        geom_histogram(stat='count')
g7 <- ggplot(data=df.combined, aes(x=as.factor(GarageFinish))) +
        geom_histogram(stat='count')

layout <- matrix(c(1,5,5,2,3,8,6,4,7),3,3,byrow=TRUE)
multiplot(g1, g2, g3, g4, g5, g6, g7, layout=layout)

```

###Basement variables
```{r, warning=FALSE, message=FALSE, out.width="100%"}
b1 <- ggplot(data=df.combined, aes(x=BsmtFinSF1)) +
        geom_histogram() + labs(x='Type 1 finished square feet')
b2 <- ggplot(data=df.combined, aes(x=BsmtFinSF2)) +
        geom_histogram()+ labs(x='Type 2 finished square feet')
b3 <- ggplot(data=df.combined, aes(x=BsmtUnfSF)) +
        geom_histogram()+ labs(x='Unfinished square feet')
b4 <- ggplot(data=df.combined, aes(x=as.factor(BsmtFinType1))) +
        geom_histogram(stat='count')+ labs(x='Rating of Type 1 finished area')
b5 <- ggplot(data=df.combined, aes(x=as.factor(BsmtFinType2))) +
        geom_histogram(stat='count')+ labs(x='Rating of Type 2 finished area')
b6 <- ggplot(data=df.combined, aes(x=as.factor(BsmtQual))) +
        geom_histogram(stat='count')+ labs(x='Height of the basement')
b7 <- ggplot(data=df.combined, aes(x=as.factor(BsmtCond))) +
        geom_histogram(stat='count')+ labs(x='Rating of general condition')
b8 <- ggplot(data=df.combined, aes(x=as.factor(BsmtExposure))) +
        geom_histogram(stat='count')+ labs(x='Walkout or garden level walls')

layout <- matrix(c(1,2,3,4,5,9,6,7,8),3,3,byrow=TRUE)
multiplot(b1, b2, b3, b4, b5, b6, b7, b8, layout=layout)

```

### Feature engineering

The bathroom variables will be combined for the reason that I find it strange that these don't have a important role. By combining these I expect a more prominent role.
```{r}
df.combined$TotBathrooms = df.combined$BsmtFullBath + (df.combined$BsmtHalfBath * 0.5) + df.combined$FullBath + (df.combined$HalfBath * 0.5)
```
As expected it shows a pretty good correlaton between the bathroom variable and the saleprice
```{r, warning=FALSE}
tb1 <- ggplot(data=df.combined[!is.na(df.combined$SalePrice),], aes(x=as.factor(TotBathrooms), y=SalePrice))+
        geom_point(col='blue') + geom_smooth(method = "lm", se=FALSE, color="black", aes(group=1)) +
        scale_y_continuous(breaks= seq(0, 800000, by=100000), labels = comma)
tb2 <- ggplot(data=df.combined, aes(x=as.factor(TotBathrooms))) +
        geom_histogram(stat='count')
grid.arrange(tb1, tb2)
```

##Adding 'House Age', 'Remodeled (Yes/No)', and IsNew variable

Altogether, there are 3 variables that are relevant with regards to the Age of a house; YearBlt, YearRemodAdd, and YearSold. YearRemodAdd defaults to YearBuilt if there has been no Remodeling/Addition. I will use YearRemodeled and YearSold to determine the Age. However, as parts of old constructions will always remain and only parts of the house might have been renovated, I will also introduce a Remodeled Yes/No variable. This should be seen as some sort of penalty parameter that indicates that if the Age is based on a remodeling date, it is probably worth less than houses that were built from scratch in that same year.

```{r}
df.combined$Remod <- ifelse(df.combined$YearBuilt==df.combined$YearRemodAdd, 0, 1) #0=No Remodeling, 1=Remodeling
df.combined$Age <- as.numeric(df.combined$YrSold)-df.combined$YearRemodAdd
```

As expected there is a negative correlation toward older houses on regard with their saleprices.
```{r}
ggplot(data=df.combined[!is.na(df.combined$SalePrice),], aes(x=Age, y=SalePrice))+
        geom_point(col='blue') + geom_smooth(method = "lm", se=FALSE, color="black", aes(group=1)) +
        scale_y_continuous(breaks= seq(0, 800000, by=100000), labels = comma)
```

Remoddeld houses are less worth.
```{r, out.width="50%"}
ggplot(df.combined[!is.na(df.combined$SalePrice),], aes(x=as.factor(Remod), y=SalePrice)) +
        geom_bar(stat='summary', fun.y = "median", fill='blue') +
        geom_label(stat = "count", aes(label = ..count.., y = ..count..), size=6) +
        scale_y_continuous(breaks= seq(0, 800000, by=50000), labels = comma) +
        theme_grey(base_size = 18) +
        geom_hline(yintercept=163000, linetype="dashed") #dashed line is median SalePrice
```

Finally, I am creating the IsNew variable below. Altogether, there are 116 new houses in the dataset.

```{r}
df.combined$IsNew <- ifelse(df.combined$YrSold==df.combined$YearBuilt, 1, 0)
table(df.combined$IsNew)
```

These 116 new houses are fairly evenly distributed among train and test set, and as you can see new houses are worth considerably more on average.

```{r, out.width="50%"}
ggplot(df.combined[!is.na(df.combined$SalePrice),], aes(x=as.factor(IsNew), y=SalePrice)) +
        geom_bar(stat='summary', fun.y = "median", fill='blue') +
        geom_label(stat = "count", aes(label = ..count.., y = ..count..), size=6) +
        scale_y_continuous(breaks= seq(0, 800000, by=50000), labels = comma) +
        theme_grey(base_size = 18) +
        geom_hline(yintercept=163000, linetype="dashed") #dashed line is median SalePrice
```

```{r}
df.combined$YrSold <- as.factor(df.combined$YrSold) #the numeric version is now not needed anymore
```

##Binning Neighborhood

Both the median and mean Saleprices agree on 3 neighborhoods with substantially higher saleprices. The separation of the 3 relatively poor neighborhoods is less clear, but at least both graphs agree on the same 3 poor neighborhoods. Since I do not want to 'overbin', I am only creating categories for those 'extremes'.
```{r}
nb1 <- ggplot(df.combined[!is.na(df.combined$SalePrice),], aes(x=reorder(Neighborhood, SalePrice, FUN=median), y=SalePrice)) +
        geom_bar(stat='summary', fun.y = "median", fill='blue') + labs(x='Neighborhood', y='Median SalePrice') +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        scale_y_continuous(breaks= seq(0, 800000, by=50000), labels = comma) +
        geom_label(stat = "count", aes(label = ..count.., y = ..count..), size=3) +
        geom_hline(yintercept=163000, linetype="dashed", color = "red") #dashed line is median SalePrice
nb2 <- ggplot(df.combined[!is.na(df.combined$SalePrice),], aes(x=reorder(Neighborhood, SalePrice, FUN=mean), y=SalePrice)) +
        geom_bar(stat='summary', fun.y = "mean", fill='blue') + labs(x='Neighborhood', y="Mean SalePrice") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        scale_y_continuous(breaks= seq(0, 800000, by=50000), labels = comma) +
        geom_label(stat = "count", aes(label = ..count.., y = ..count..), size=3) +
        geom_hline(yintercept=163000, linetype="dashed", color = "red") #dashed line is median SalePrice
grid.arrange(nb1, nb2)
```

```{r}
df.combined$NeighRich[df.combined$Neighborhood %in% c('StoneBr', 'NridgHt', 'NoRidge')] <- 2
df.combined$NeighRich[!df.combined$Neighborhood %in% c('MeadowV', 'IDOTRR', 'BrDale', 'StoneBr', 'NridgHt', 'NoRidge')] <- 1
df.combined$NeighRich[df.combined$Neighborhood %in% c('MeadowV', 'IDOTRR', 'BrDale')] <- 0
```

##Total Square Feet

As the total living space generally is very important when people buy houses, I am adding a predictors that adds up the living space above and below ground. The increase in sqaure feet seems the have a very postive correlation with saleprice.

```{r}
df.combined$TotalSqFeet <- df.combined$GrLivArea + df.combined$TotalBsmtSF
ggplot(data=df.combined[!is.na(df.combined$SalePrice),], aes(x=TotalSqFeet, y=SalePrice))+
        geom_point(col='blue') + geom_smooth(method = "lm", se=FALSE, color="black", aes(group=1)) +
        scale_y_continuous(breaks= seq(0, 800000, by=100000), labels = comma) +
        geom_text_repel(aes(label = ifelse(df.combined$GrLivArea[!is.na(df.combined$SalePrice)]>4500, rownames(df.combined), '')))
```

## Perparing data for modeling

### Dropping highly ccorrelated variables
First of all, I am dropping a variable if two variables are highly correlated. These were chosen based on the produced correlation plots.
```{r}
dropVars <- c('YearRemodAdd', 'GarageYrBlt', 'GarageArea', 'GarageCond', 'TotalBsmtSF', 'TotalRmsAbvGrd', 'BsmtFinSF1')
df.combined = df.combined[,!(names(df.combined) %in% dropVars)]
```

### Removing outliers
Removing the two houses that have very high area but a low saleprice, for the reason that these might mess up the prediction model
```{r}
df.combined = df.combined[-c(524,1299),]
```

##PreProcessing predictor variables

Before modeling I need to center and scale the 'true numeric' predictors (so not variables that have been label encoded), and create dummy variables for the categorical predictors. I split the dataframe into one with all (true) numeric variables, and another dataframe holding the (ordinal) factors.

```{r}
numericVarNames <- numVar[!(numVar %in% c('MSSubClass', 'MoSold', 'YrSold', 'SalePrice', 'OverallQual', 'OverallCond'))] #numericVarNames was created before having done anything
numericVarNames <- append(numericVarNames, c('Age', 'TotalPorchSF', 'TotBathrooms', 'TotalSqFeet'))

DFnumeric <- df.combined[, names(df.combined) %in% numericVarNames]

DFfactors <- df.combined[, !(names(df.combined) %in% numericVarNames)]
DFfactors <- DFfactors[, names(DFfactors) != 'SalePrice']

cat('There are', length(DFnumeric), 'numeric variables, and', length(DFfactors), 'factor variables')
```

### Skewness and normalizing
Skewness is a measure of the symmetry in a distribution. In order to fix the skewness, I am taking the log for all numeric predictors with an absolute skew greater than 0.8 (actually: log+1, to avoid division by zero issues).
```{r}
for(i in 1:ncol(DFnumeric)){
        if (abs(skew(DFnumeric[,i]))>0.8){
                DFnumeric[,i] <- log(DFnumeric[,i] +1)
        }
}
```

```{r}
PreNum <- preProcess(DFnumeric, method=c("center", "scale"))
print(PreNum)
```
```{r}
DFnorm <- predict(PreNum, DFnumeric)
dim(DFnorm)
```

###One hot encoding the categorical variables

'one-hot encode' the categorical variables. This basically means that all factor values are seperated into colums with 1s and 0s.

```{r}
DFdummies <- as.data.frame(model.matrix(~.-1, DFfactors))
dim(DFdummies)
```

###Removing levels with few or no observations in train or test

```{r}
#check if some values are absent in the test set
ZerocolTest <- which(colSums(DFdummies[(nrow(df.combined[!is.na(df.combined$SalePrice),])+1):nrow(df.combined),])==0)
colnames(DFdummies[ZerocolTest])
DFdummies <- DFdummies[,-ZerocolTest] #removing predictors
```

```{r}
#check if some values are absent in the train set
ZerocolTrain <- which(colSums(DFdummies[1:nrow(df.combined[!is.na(df.combined$SalePrice),]),])==0)
colnames(DFdummies[ZerocolTrain])
DFdummies <- DFdummies[,-ZerocolTrain] #removing predictor
```

Also taking out variables with less than 10 'ones' in the train set.

```{r}
fewOnes <- which(colSums(DFdummies[1:nrow(df.combined[!is.na(df.combined$SalePrice),]),])<10)
colnames(DFdummies[fewOnes])
DFdummies <- DFdummies[,-fewOnes] #removing predictors
dim(DFdummies)
```

```{r}
combined <- cbind(DFnorm, DFdummies) #combining all (now numeric) predictors into one dataframe 
```

##Dealing with skewness of response variable

```{r}
skew(df.combined$SalePrice)
```

```{r}
qqnorm(df.combined$SalePrice)
qqline(df.combined$SalePrice)
```
log fold and "+1" is not necessary as there are no 0's
```{r}
df.combined$SalePrice <- log(df.combined$SalePrice)
skew(df.combined$SalePrice)
```

As you can see,the skew is now quite low and the Q-Q plot is also looking much better.

```{r}
qqnorm(df.combined$SalePrice)
qqline(df.combined$SalePrice)
```

##Composing train and test sets

```{r}
train1 <- combined[!is.na(df.combined$SalePrice),]
test1 <- combined[is.na(df.combined$SalePrice),]
```

##Lasso regression model
Lasso picks only one of the correlated predictors. For fiding the best lambda we will use crossvaldiation from the caret package

```{r}
set.seed(27042018)
my_control <-trainControl(method="cv", number=5)
lassoGrid <- expand.grid(alpha = 1, lambda = seq(0.001,0.1,by = 0.0005))

lasso_mod <- train(x=train1, y=df.combined$SalePrice[!is.na(df.combined$SalePrice)], method='glmnet', trControl= my_control, tuneGrid=lassoGrid) 
lasso_mod$bestTune
min(lasso_mod$results$RMSE)
```

The documentation of the caret `varImp' function says: for glmboost and glmnet the absolute value of the coefficients corresponding to the tuned model are used.
Although this means that a real ranking of the most important variables is not stored, it gives me the opportunity to find out how many of the variables are not used in the model (and hence have coefficient 0). The Lasso selected only 1/5 of the total amount of predictors.

```{r}
lassoVarImp <- varImp(lasso_mod,scale=F)
lassoImportance <- lassoVarImp$importance

varsSelected <- length(which(lassoImportance$Overall!=0))
varsNotSelected <- length(which(lassoImportance$Overall==0))

cat('Lasso uses', varsSelected, 'variables in its model, and did not select', varsNotSelected, 'variables.')
```
Prediction of the lasso model
```{r}
LassoPred <- predict(lasso_mod, test1)
predictions_lasso <- exp(LassoPred) #need to reverse the log to the real values
head(predictions_lasso)
```

##XGBoost model
Change the data into the xgb.matrix structure.
```{r}
label_train <- df.combined$SalePrice[!is.na(df.combined$SalePrice)]

# put our testing & training data into two seperates Dmatrixs objects
dtrain <- xgb.DMatrix(data = as.matrix(train1), label= label_train)
dtest <- xgb.DMatrix(data = as.matrix(test1))
```
Parameter settings.
```{r}
default_param<-list(
        objective = "reg:linear",
        booster = "gbtree",
        eta=0.05, #default = 0.3
        gamma=0,
        max_depth=3, #default=6
        min_child_weight=4, #default=1
        subsample=1,
        colsample_bytree=1
)
```

```{r}
xgb_mod <- xgb.train(data = dtrain, params=default_param, nrounds = 454)
```

```{r}
XGBpred <- predict(xgb_mod, dtest)
predictions_XGB <- exp(XGBpred)
head(predictions_XGB)
```

